<template>
    <div v-if="taskDetail" v-hotkey="mapKeys">
        <b-row class="mb-4">
            <b-col>
                <b-button to="/pentest">Back</b-button>
            </b-col>
        </b-row>
        <b-row class="mb-3">
            <b-col cols="2" class="text-right">
                <b>Attacker</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.attacker.name }}
            </b-col>
        </b-row>
        <b-row class="mb-3">
            <b-col cols="2" class="text-right">
                <b>Target</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.target.name }}
            </b-col>
        </b-row>
        <b-row class="mb-3">
            <b-col cols="2" class="text-right">
                <b>Service</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.target_service && taskDetail.target_service.service.name + ' (' + taskDetail.target_service.port.number + ':' + taskDetail.target_service.port.protocol + ')' }}
            </b-col>
        </b-row>
        <b-row class="mb-4">
            <b-col cols="2" class="text-right">
                <b>Action</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.action.name }}
            </b-col>
        </b-row>
        <b-row class="mb-3">
            <b-col cols="2" class="text-right">
                <b>Credential</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.credential && taskDetail.credential.username + ' (' + taskDetail.credential.cred_type + ')' }}
            </b-col>
        </b-row>
        <b-row class="mb-4">
            <b-col cols="2" class="text-right">
                <b>Vulnerability</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.action.vulnerability && taskDetail.action.vulnerability.name }}
            </b-col>
        </b-row>
        <b-row class="mb-4">
            <b-col cols="2" class="text-right">
                <b>Tool</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.action.tool && taskDetail.action.tool.name }}
            </b-col>
        </b-row>
        <b-row class="mb-3">
            <b-col cols="2" class="text-right">
                <b>Create Date</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.create_date }}
            </b-col>
        </b-row>
        <b-row class="mb-3">
            <b-col cols="2" class="text-right">
                <b>Write Date</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.write_date }}
            </b-col>
        </b-row>
        <b-row class="mb-4">
            <b-col cols="2" class="text-right">
                <b>State</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskResult && taskResult.state }}
            </b-col>
        </b-row>
        <b-row class="mb-4">
            <b-col cols="2" class="text-right">
                <b>Command</b>
            </b-col>
            <b-col cols="10" class="text-left">
                {{ taskDetail.command }}
            </b-col>
        </b-row>
        <b-row class="mb-3">
            <b-col cols="2" class="text-right">
                <b>Output</b>
            </b-col>
            <b-col cols="10" class="text-left">
                <div v-html="processedAnsi"></div>
            </b-col>
        </b-row>
        <b-row class="mb-4" v-if="showTextToCopy">
            <b-form-textarea
                ref="textarea-task-copy"
                v-on:focus="$event.target.select()"
                :value=textToCopy
            ></b-form-textarea>
        </b-row>
        <b-row>
            <b-col align="center">
                <b-button variant="primary" size="sm" @click="onClickTaskCopy">Copy</b-button>
            </b-col>
        </b-row>
    </div>
</template>

<script>
import Vuex from 'vuex'
import Convert from 'ansi-to-html';
import stripAnsi from 'strip-ansi';

const convert = new Convert({
  newline: true
});

export default {
    name: 'PentestTaskOpen',
    data() {
        return {
            showTextToCopy: false,
            textToCopy: ''
        }
    },
    computed: {
        ...Vuex.mapGetters('pentest', [
            'getTaskById',
            'getTaskResultByTaskId'
        ]),
        taskDetail() {
            return this.getTaskById(Number(this.$route.params.id));
        },
        taskResult() {
            return this.getTaskResultByTaskId(Number(this.$route.params.id));
        },
        processedAnsi() {
            if (this.taskResult) {
                return convert.toHtml(this.taskResult.output);
            }
            return '';
        },
        strippedAnsi() {
            if (this.taskResult) {
                return stripAnsi(this.taskResult.output);
            }
            return '';
        },
        mapKeys() {
            return {
                "ctrl+c": this.onClickTaskCopy
            };
        }
    },
    methods: {
        async onClickTaskCopy() {
            var text = '# Phase ' + this.taskDetail.action.phase.sequence + ' - ' + this.taskDetail.action.phase.name;
            text += '\n\n';
            text += '## Action' + ' - ' + this.taskDetail.action.name + '\n';
            text += '```' + '\n';
            text += '$ ' + this.taskDetail.command + '\n';
            text += this.strippedAnsi  + '\n';
            text += '```';
            this.showTextToCopy = true;
            this.textToCopy = text;
            await this.$nextTick();
            this.$refs['textarea-task-copy'].focus();
            document.execCommand('copy');
            this.showTextToCopy = false;
        }
    }
}
</script>