<template>
    <div>
        <b-row class="mb-4">
            <b-col>
                <b-button to="/pentest">Back</b-button>
            </b-col>
        </b-row>
       <div>
           <PentestAttackerOpen v-bind:attacker_id="selected_attacker"/>
           <PentestTargetOpen v-bind:target_id="selected_target"/>
       </div>
        <b-row class="mb-4">
            <b-col lg="6">
                <b-input-group prepend="Attacker" size="sm" class="mb-2">
                    <b-form-select :value="selected_attacker" :options="optionsAttackers" @input="onInputSelected('selected_attacker', $event)"></b-form-select>      
                    <b-input-group-append>
                        <b-button @click="onClickAttacker"><b-icon icon="gear-fill" aria-hidden="true"></b-icon></b-button>
                    </b-input-group-append>
                </b-input-group>
                <b-input-group prepend="Target" size="sm" class="mb-2">
                    <b-form-select :value="selected_target" :options="optionsTargets" @input="onInputSelected('selected_target', $event)"></b-form-select>
                    <b-input-group-append>
                        <b-button @click="onClickTarget"><b-icon icon="gear-fill" aria-hidden="true"></b-icon></b-button>
                    </b-input-group-append>
                </b-input-group>
            </b-col>
            <b-col lg="6">
                <b-input-group prepend="Phase" size="sm" class="mb-2">
                    <b-form-select :value="selected_phase" :options="optionsPhases" :disabled="selected_target === null" @input="onInputSelected('selected_phase', $event)"></b-form-select>         
                </b-input-group>
                <b-input-group prepend="Service" size="sm" class="mb-2">
                    <b-form-select :value="selected_service" :options="optionsTargetServices" :disabled="selected_target === null || selected_phase === null" @input="onInputSelected('selected_service', $event)"></b-form-select>
                </b-input-group>
            </b-col>
        </b-row>
        <b-row class="mb-4">
            <b-col>
                <b-button size="sm" variant="primary" class="mb-2" @click="onClickSearchActions">
                    <b-icon icon="search"></b-icon> Search Actions
                </b-button>
            </b-col>
        </b-row>
        <b-row>
            <b-col>
                <b-table-simple v-if="actions.length">
                    <b-thead>
                        <b-tr>
                            <b-th>
                                <input type="checkbox" v-model="select_all" @click="onClickSelectAllActions">
                            </b-th>
                            <b-th>Name</b-th>
                            <b-th>Tool</b-th>
                            <b-th>Command</b-th>
                        </b-tr>
                    </b-thead>
                    <b-tbody>
                        <b-tr v-for="a in actions" :key="a.id">
                            <b-td>
                                <label class="form-checkbox">
                                    <input type="checkbox" :value="a.id" v-model="selected_actions">
                                    <i class="form-icon"></i>
                                </label>
                            </b-td>
                            <b-td>{{a.name}}</b-td>
                            <b-td>{{a.tool}}</b-td>
                            <b-td>{{a.command}}</b-td>
                        </b-tr>
                    </b-tbody>
                </b-table-simple>
            </b-col>
        </b-row>
        <b-row v-if="selected_actions.length">
            <b-col>
                <b-button size="sm" variant="primary" @click="onClickRunActions">
                    <b-icon icon="play-fill"></b-icon> Run Actions
                </b-button>
            </b-col>
        </b-row>
    </div>
</template>

<script>
import Vuex from 'vuex'

import PentestAttackerOpen from '@/components/PentestAttackerOpen.vue'
import PentestTargetOpen from '@/components/PentestTargetOpen.vue'

export default {
    name: 'PentestTaskCreate',
    components: {
        PentestAttackerOpen,
        PentestTargetOpen
    },
    data() {
        return {
            actions: [],
            selected_actions: [],
            select_all: false
        }
    },
    computed: {
        ...Vuex.mapState('pentest', [
            'attackers',
            'targets',
            'phases',
            'services',
            'selected_attacker',
            'selected_target',
            'selected_phase',
            'selected_service'
        ]),
        ...Vuex.mapGetters('pentest', [
            'getTargetById',
            'getActionsByPhaseAndService'
        ]),
        optionsAttackers() {
            var options = this.attackers.map(x => ({value: x.id, text: x.name}));
            options.unshift({value: null, text: ''});
            return options;
        },
        optionsTargets() {
            var options = this.targets.map(x => ({value: x.id, text: x.name}));
            options.unshift({value: null, text: ''});
            return options;
        },
        optionsPhases() {
            var options = this.phases.map(x => ({value: x.id, text: x.name}));
            options.unshift({value: null, text: ''});
            return options;
        },
        optionsTargetServices() {
            var options = [{value: null, text: ''}];
            if (this.selected_target) {
                var target = this.getTargetById(this.selected_target);
                if (target)
                    options = options.concat(target.services.map(x => ({value: x.service.id, text: x.service.name + ' (' + x.port.number + ':' + x.port.protocol + ')'})));
            }
            return options;
        }
    },
    methods: {
        ...Vuex.mapActions('pentest', [
            'updateSelectedProp',
            'createTask'
        ]),
        onInputSelected(prop, value) {
            this.updateSelectedProp({prop, value});
        },
        onClickAttacker() {
            this.$bvModal.show('modal-attacker');
        },
        onClickTarget() {
            this.$bvModal.show('modal-target');
        },
        onClickSelectAllActions() {
            this.selected_actions = [];
            if (!this.select_all) {
                for (let x in this.actions) {
                    this.selected_actions.push(this.actions[x].id);
                }
            }
        },
        onClickSearchActions() {
            this.selected_actions = [];
            var phase_id = this.selected_phase || null;
            var service_id = this.selected_service || null;
            var actions = this.getActionsByPhaseAndService(phase_id, service_id) || [];
            this.actions = actions.map(x => ({id: x.id, name: x.name, tool: x.tool.name, command: x.command}));
        },
        onClickRunActions() {
            for (let x in this.selected_actions) {
                var data = {
                    attacker_id: this.selected_attacker,
                    target_id: this.selected_target,
                    action_id: this.selected_actions[x]
                }
                this.createTask(data).then(() => {
                    this.$router.push(`/pentest`);
                });
            }
        }
    }
}
</script>