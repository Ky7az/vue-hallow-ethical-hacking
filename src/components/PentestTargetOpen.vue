<template>
    <div>
        <b-modal id="modal-target" title="Target" hide-footer>
            <div>
                <b-form ref="form_target" @submit.prevent="onClickSubmitForm">
                    <b-row class="mb-1">
                        <b-col sm="3">
                            <label>Name</label>
                        </b-col>
                        <b-col sm="9">
                            <b-form-input name="name" :value="targetDetail && targetDetail.name || null" size="sm" required></b-form-input>
                        </b-col>
                    </b-row>
                    <b-row class="mb-4">
                        <b-col sm="3">
                            <label>Host</label>
                        </b-col>
                        <b-col sm="9">
                            <b-form-input name="host" :value="targetDetail && targetDetail.host || null" size="sm" required></b-form-input>
                        </b-col>
                    </b-row>
                    <b-row>
                        <b-col>
                            <b-table-simple v-if="targetDetail && targetDetail.services">
                                <b-thead>
                                    <b-tr>
                                        <b-th>Service</b-th>
                                        <b-th>Port</b-th>
                                    </b-tr>
                                </b-thead>
                                <b-tbody>
                                    <b-tr v-for="x in targetDetail.services" :key="x.id">
                                        <b-td>{{x.service.name}}</b-td>
                                        <b-td>{{x.port.number}}:{{x.port.protocol}}</b-td>
                                    </b-tr>
                                </b-tbody>
                            </b-table-simple>
                        </b-col>
                    </b-row>
                    <b-row>
                        <b-col align="center">
                            <b-button variant="danger" size="sm" class="m-1" @click="onClickTargetDelete" v-if="targetDetail">Delete</b-button>
                            <b-button type="submit" variant="primary" size="sm" class="m-1" v-if="!targetDetail">Create</b-button>
                            <b-button type="submit" variant="primary" size="sm" class="m-1" v-if="targetDetail">Save</b-button>
                        </b-col>
                    </b-row>
                </b-form>
            </div>
        </b-modal>
    </div>
</template>

<script>
import Vuex from 'vuex'
import slugify from 'slugify';

export default {
    name: 'PentestTargetOpen',
    props: {
        target_id: Number
    },
    data() {
        return {
        }
    },
    computed: {
        ...Vuex.mapState('pentest', [
            'services',
            'ports'
        ]),
        ...Vuex.mapGetters('pentest', [
            'getTargetById'
        ]),
        targetDetail() {
            return this.getTargetById(this.target_id);
        },
        optionsServices() {
            var options = this.services.map(x => ({value: x.id, text: x.name}));
            options.unshift({value: null, text: ''});
            return options;
        },
        optionsPorts() {
            var options = this.ports.map(x => ({value: x.id, text: x.number + ':' + x.protocol}));
            options.unshift({value: null, text: ''});
            return options;
        }
    },
    methods: {
        ...Vuex.mapActions('pentest', [
            'createTarget',
            'updateTarget',
            'deleteTarget',
            'updateSelectedProp'
        ]),
        updateSelectedTarget(target_id) {
            this.updateSelectedProp({prop: 'selected_target', value: target_id});
        },
        closeModal() {
            this.$bvModal.hide('modal-target');
        },
        onClickSubmitForm() {
            var data = {
                name: this.$refs.form_target.name.value,
                host: this.$refs.form_target.host.value
            }
            data.slug = slugify(data.name, {'replacement': '-', 'lower': true});
            if (!this.targetDetail) {
                this.createTarget(data).then((res) => {
                    this.updateSelectedTarget(res.id);
                    this.closeModal();
                });
            }
            else {
                this.updateTarget({target: this.targetDetail, data}).then((res) => {
                    this.updateSelectedTarget(res.id);
                    this.closeModal();
                });
            }
        },
        onClickTargetDelete() {
            var is_ok = confirm("Delete Target ?");
            if (is_ok) {
                this.deleteTarget(this.targetDetail).then(() => {
                    this.closeModal();
                });
            };
        }
    }
}
</script>