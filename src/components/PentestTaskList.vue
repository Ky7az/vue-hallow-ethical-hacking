<template>
    <div>
        <b-row>
            <b-col>
                <b-button to="/pentest/new">New</b-button>
            </b-col>
        </b-row>
        <b-row>
            <b-col class="m-4">
                <b-table-simple v-if="this.tasks">
                    <b-thead>
                        <b-tr>
                            <b-th>Attacker</b-th>
                            <b-th>Target</b-th>
                            <b-th>Service</b-th>
                            <b-th>Action</b-th>
                            <b-th>State</b-th>
                            <b-th></b-th>
                            <b-th></b-th>
                            <b-th></b-th>
                        </b-tr>
                    </b-thead>
                    <b-tbody>
                        <b-tr v-for="taskDetail in tasks" :key="taskDetail.id">
                            <b-td>{{ taskDetail.attacker.name }}</b-td>
                            <b-td>{{ taskDetail.target.name }}</b-td>
                            <b-td>{{ taskDetail.target_service && taskDetail.target_service.service.name + ' (' + taskDetail.target_service.port.number + ':' + taskDetail.target_service.port.protocol + ')' }}</b-td>
                            <b-td>{{ taskDetail.action.name }}</b-td>
                            <b-td>{{ getTaskState(taskDetail.id) }}</b-td>
                            <b-td>
                                <router-link :to="`/pentest/tsk/${taskDetail.id}`">
                                    <b-icon icon="arrow-up-right-circle" title="Open" class="orange"></b-icon>
                                </router-link>
                            </b-td>
                            <b-td>
                                <b-icon icon="clipboard-data" title="Copy to Clipboard" class="orange" @click="onClickTaskCopy(taskDetail)"></b-icon>
                            </b-td>
                            <b-td>
                                <b-icon icon="x-square" title="Delete" class="orange" @click="onClickTaskDelete(taskDetail)"></b-icon>
                            </b-td>
                        </b-tr>
                    </b-tbody>
                </b-table-simple>
            </b-col>
        </b-row>
    </div>
</template>

<script>
import Vuex from 'vuex'
import stripAnsi from 'strip-ansi';

import { TokenService } from '../storage/service'

export default {
    name: 'PentestTaskList',
    data() {
        return {
        }
    },
    computed: {
        ...Vuex.mapState('pentest', [
            'tasks'
        ]),
        ...Vuex.mapGetters('pentest', [
            'getTaskResultByTaskId'
        ])
    },
    methods: {
        ...Vuex.mapActions('pentest', [
            'loadTasksResults',
            'deleteTask'
        ]),
        pollTaskResults() {
            this.$options.interval = setInterval(() => {
                this.loadTasksResults();
            }, 2000);
        },
        getTaskState(taskId) {
            var taskResult = this.getTaskResultByTaskId(taskId);
            if (taskResult)
                return taskResult.state;
            return 'UNKNOWN'
        },
        getTaskResult(taskId) {
            var taskResult = this.getTaskResultByTaskId(taskId);
            if (taskResult)
                return stripAnsi(taskResult.output)
            return ''
        },
        onClickTaskCopy(taskDetail) {
            var text = '# Phase ' + taskDetail.action.phase.sequence + ' - ' + taskDetail.action.phase.name;
            text += '\n\n';
            text += '## Action' + ' - ' + taskDetail.action.name + '\n'
            text += '```' + '\n'
            text += '$ ' + taskDetail.command + '\n'
            text += this.getTaskResult(taskDetail.id);
            text += '\n' + '```'
            navigator.clipboard.writeText(text);
        },
        onClickTaskDelete(taskDetail) {
            var is_ok = confirm("Delete Task ?");
            if (is_ok) {
                this.deleteTask(taskDetail);
            };
        }
    },
    created() {
        if (TokenService.getToken()) {
            this.pollTaskResults();
        }
    },
    beforeDestroy() {
        clearInterval(this.$options.interval);
    }
}
</script>